(function(doc,undefined){"use strict";var DOCUMENT_POSITION_PRECEDING=2;var ELEMENT_NODE=1;var TEXT_NODE=3;var SHOW_ELEMENT=1;var SHOW_TEXT=4;var START_TO_START=0;var START_TO_END=1;var END_TO_END=2;var END_TO_START=3;var ZWS="​";var win=doc.defaultView;var ua=navigator.userAgent;var isIOS=/iP(?:ad|hone|od)/.test(ua);var isMac=/Mac OS X/.test(ua);var isGecko=/Gecko\//.test(ua);var isIElt11=/Trident\/[456]\./.test(ua);var isPresto=!!win.opera;var isWebKit=/WebKit\//.test(ua);var ctrlKey=isMac?"meta-":"ctrl-";var useTextFixer=isIElt11||isPresto;var useNonEmptyFixer=isIElt11;var cantFocusEmptyTextNodes=isIElt11||isWebKit;var losesSelectionOnBlur=isIElt11;var canObserveMutations=typeof MutationObserver!=="undefined";var notWS=/[^ \t\r\n]/;var indexOf=Array.prototype.indexOf;var typeToBitArray={1:1,2:2,3:4,8:128,9:256,11:1024};function TreeWalker(root,nodeType,filter){this.root=this.currentNode=root;this.nodeType=nodeType;this.filter=filter}TreeWalker.prototype.nextNode=function(){var current=this.currentNode,root=this.root,nodeType=this.nodeType,filter=this.filter,node;while(true){node=current.firstChild;while(!node&&current){if(current===root){break}node=current.nextSibling;if(!node){current=current.parentNode}}if(!node){return null}if(typeToBitArray[node.nodeType]&nodeType&&filter(node)){this.currentNode=node;return node}current=node}};TreeWalker.prototype.previousNode=function(){var current=this.currentNode,root=this.root,nodeType=this.nodeType,filter=this.filter,node;while(true){if(current===root){return null}node=current.previousSibling;if(node){while(current=node.lastChild){node=current}}else{node=current.parentNode}if(!node){return null}if(typeToBitArray[node.nodeType]&nodeType&&filter(node)){this.currentNode=node;return node}current=node}};var inlineNodeNames=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|FN|EL)|EM|FONT|HR|I(?:NPUT|MG|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:U[BP]|PAN|TR(?:IKE|ONG)|MALL|AMP)?|U|VAR|WBR)$/;var leafNodeNames={BR:1,HR:1,IMG:1,INPUT:1,WBR:1};function every(nodeList,fn){var l=nodeList.length;while(l--){if(!fn(nodeList[l])){return false}}return true}function hasTagAttributes(node,tag,attributes){if(node.nodeName!==tag){return false}for(var attr in attributes){if(node.getAttribute(attr)!==attributes[attr]){return false}}return true}function areAlike(node,node2){return node.nodeType===node2.nodeType&&node.nodeName===node2.nodeName&&node.className===node2.className&&(!node.style&&!node2.style||node.style.cssText===node2.style.cssText)}function isLeaf(node){return node.nodeType===ELEMENT_NODE&&!!leafNodeNames[node.nodeName]}function isInline(node){return inlineNodeNames.test(node.nodeName)}function isBlock(node){return node.nodeType===ELEMENT_NODE&&!isInline(node)&&every(node.childNodes,isInline)}function isContainer(node){return node.nodeType===ELEMENT_NODE&&!isInline(node)&&!isBlock(node)}function getBlockWalker(node){var doc=node.ownerDocument,walker=new TreeWalker(doc.body,SHOW_ELEMENT,isBlock,false);walker.currentNode=node;return walker}function getPreviousBlock(node){return getBlockWalker(node).previousNode()}function getNextBlock(node){return getBlockWalker(node).nextNode()}function getNearest(node,tag,attributes){do{if(hasTagAttributes(node,tag,attributes)){return node}}while(node=node.parentNode);return null}function getPath(node){var parent=node.parentNode,path,id,className,classNames;if(!parent||node.nodeType!==ELEMENT_NODE){path=parent?getPath(parent):""}else{path=getPath(parent);path+=(path?">":"")+node.nodeName;if(id=node.id){path+="#"+id}if(className=node.className.trim()){classNames=className.split(/\s\s*/);classNames.sort();path+=".";path+=classNames.join(".")}}return path}function getLength(node){var nodeType=node.nodeType;return nodeType===ELEMENT_NODE?node.childNodes.length:node.length||0}function detach(node){var parent=node.parentNode;if(parent){parent.removeChild(node)}return node}function replaceWith(node,node2){var parent=node.parentNode;if(parent){parent.replaceChild(node2,node)}}function empty(node){var frag=node.ownerDocument.createDocumentFragment(),childNodes=node.childNodes,l=childNodes?childNodes.length:0;while(l--){frag.appendChild(node.firstChild)}return frag}function createElement(doc,tag,props,children){var el=doc.createElement(tag),attr,value,i,l;if(props instanceof Array){children=props;props=null}if(props){for(attr in props){value=props[attr];if(value!==undefined){el.setAttribute(attr,props[attr])}}}if(children){for(i=0,l=children.length;i<l;i+=1){el.appendChild(children[i])}}return el}function fixCursor(node){var doc=node.ownerDocument,root=node,fixer,child,instance;if(node.nodeName==="BODY"){if(!(child=node.firstChild)||child.nodeName==="BR"){instance=getSquireInstance(doc);fixer=instance?instance.createDefaultBlock():createElement(doc,"DIV");if(child){node.replaceChild(fixer,child)}else{node.appendChild(fixer)}node=fixer;fixer=null}}if(isInline(node)){child=node.firstChild;while(cantFocusEmptyTextNodes&&child&&child.nodeType===TEXT_NODE&&!child.data){node.removeChild(child);child=node.firstChild}if(!child){if(cantFocusEmptyTextNodes){fixer=doc.createTextNode(ZWS);getSquireInstance(doc)._didAddZWS()}else{fixer=doc.createTextNode("")}}}else{if(useTextFixer){if(useNonEmptyFixer){if(!node.querySelector("WBR")){fixer=createElement(doc,"WBR");while((child=node.lastElementChild)&&!isInline(child)){node=child}}}else{while(node.nodeType!==TEXT_NODE&&!isLeaf(node)){child=node.firstChild;if(!child){fixer=doc.createTextNode("");break}node=child}if(node.nodeType===TEXT_NODE){if(/^ +$/.test(node.data)){node.data=""}}else if(isLeaf(node)){node.parentNode.insertBefore(doc.createTextNode(""),node)}}}else if(!node.querySelector("BR")){fixer=createElement(doc,"BR");while((child=node.lastElementChild)&&!isInline(child)){node=child}}}if(fixer){node.appendChild(fixer)}return root}function fixContainer(container){var children=container.childNodes,doc=container.ownerDocument,wrapper=null,i,l,child,isBR;for(i=0,l=children.length;i<l;i+=1){child=children[i];isBR=child.nodeName==="BR";if(!isBR&&isInline(child)){if(!wrapper){wrapper=createElement(doc,"DIV")}wrapper.appendChild(child);i-=1;l-=1}else if(isBR||wrapper){if(!wrapper){wrapper=createElement(doc,"DIV")}fixCursor(wrapper);if(isBR){container.replaceChild(wrapper,child)}else{container.insertBefore(wrapper,child);i+=1;l+=1}wrapper=null}if(isContainer(child)){fixContainer(child)}}if(wrapper){container.appendChild(fixCursor(wrapper))}return container}function split(node,offset,stopNode){var nodeType=node.nodeType,parent,clone,next;if(nodeType===TEXT_NODE&&node!==stopNode){return split(node.parentNode,node.splitText(offset),stopNode)}if(nodeType===ELEMENT_NODE){if(typeof offset==="number"){offset=offset<node.childNodes.length?node.childNodes[offset]:null}if(node===stopNode){return offset}parent=node.parentNode;clone=node.cloneNode(false);while(offset){next=offset.nextSibling;clone.appendChild(offset);offset=next}if(node.nodeName==="OL"&&getNearest(node,"BLOCKQUOTE")){clone.start=(+node.start||1)+node.childNodes.length-1}fixCursor(node);fixCursor(clone);if(next=node.nextSibling){parent.insertBefore(clone,next)}else{parent.appendChild(clone)}return split(parent,clone,stopNode)}return offset}function mergeInlines(node,range){if(node.nodeType!==ELEMENT_NODE){return}var children=node.childNodes,l=children.length,frags=[],child,prev,len;while(l--){child=children[l];prev=l&&children[l-1];if(l&&isInline(child)&&areAlike(child,prev)&&!leafNodeNames[child.nodeName]){if(range.startContainer===child){range.startContainer=prev;range.startOffset+=getLength(prev)}if(range.endContainer===child){range.endContainer=prev;range.endOffset+=getLength(prev)}if(range.startContainer===node){if(range.startOffset>l){range.startOffset-=1}else if(range.startOffset===l){range.startContainer=prev;range.startOffset=getLength(prev)}}if(range.endContainer===node){if(range.endOffset>l){range.endOffset-=1}else if(range.endOffset===l){range.endContainer=prev;range.endOffset=getLength(prev)}}detach(child);if(child.nodeType===TEXT_NODE){prev.appendData(child.data)}else{frags.push(empty(child))}}else if(child.nodeType===ELEMENT_NODE){len=frags.length;while(len--){child.appendChild(frags.pop())}mergeInlines(child,range)}}}function mergeWithBlock(block,next,range){var container=next,last,offset,_range;while(container.parentNode.childNodes.length===1){container=container.parentNode}detach(container);offset=block.childNodes.length;last=block.lastChild;if(last&&last.nodeName==="BR"||last.nodeName==="WBR"){block.removeChild(last);offset-=1}_range={startContainer:block,startOffset:offset,endContainer:block,endOffset:offset};block.appendChild(empty(next));mergeInlines(block,_range);range.setStart(_range.startContainer,_range.startOffset);range.collapse(true);if(isPresto&&(last=block.lastChild)&&last.nodeName==="BR"){block.removeChild(last)}}function mergeContainers(node){var prev=node.previousSibling,first=node.firstChild,doc=node.ownerDocument,isListItem=node.nodeName==="LI",needsFix,block;if(isListItem&&(!first||!/^[OU]L$/.test(first.nodeName))){return}if(prev&&areAlike(prev,node)){if(!isContainer(prev)){if(isListItem){block=createElement(doc,"DIV");block.appendChild(empty(prev));prev.appendChild(block)}else{return}}detach(node);needsFix=!isContainer(node);prev.appendChild(empty(node));if(needsFix){fixContainer(prev)}if(first){mergeContainers(first)}}else if(isListItem){prev=createElement(doc,"DIV");node.insertBefore(prev,first);fixCursor(prev)}}var getNodeBefore=function(node,offset){var children=node.childNodes;while(offset&&node.nodeType===ELEMENT_NODE){node=children[offset-1];children=node.childNodes;offset=children.length}return node};var getNodeAfter=function(node,offset){if(node.nodeType===ELEMENT_NODE){var children=node.childNodes;if(offset<children.length){node=children[offset]}else{while(node&&!node.nextSibling){node=node.parentNode}if(node){node=node.nextSibling}}}return node};var insertNodeInRange=function(range,node){var startContainer=range.startContainer,startOffset=range.startOffset,endContainer=range.endContainer,endOffset=range.endOffset,parent,children,childCount,afterSplit;if(startContainer.nodeType===TEXT_NODE){parent=startContainer.parentNode;children=parent.childNodes;if(startOffset===startContainer.length){startOffset=indexOf.call(children,startContainer)+1;if(range.collapsed){endContainer=parent;endOffset=startOffset}}else{if(startOffset){afterSplit=startContainer.splitText(startOffset);if(endContainer===startContainer){endOffset-=startOffset;endContainer=afterSplit}else if(endContainer===parent){endOffset+=1}startContainer=afterSplit}startOffset=indexOf.call(children,startContainer)}startContainer=parent}else{children=startContainer.childNodes}childCount=children.length;if(startOffset===childCount){startContainer.appendChild(node)}else{startContainer.insertBefore(node,children[startOffset])}if(startContainer===endContainer){endOffset+=children.length-childCount}range.setStart(startContainer,startOffset);range.setEnd(endContainer,endOffset)};var extractContentsOfRange=function(range,common){var startContainer=range.startContainer,startOffset=range.startOffset,endContainer=range.endContainer,endOffset=range.endOffset;if(!common){common=range.commonAncestorContainer}if(common.nodeType===TEXT_NODE){common=common.parentNode}var endNode=split(endContainer,endOffset,common),startNode=split(startContainer,startOffset,common),frag=common.ownerDocument.createDocumentFragment(),next,before,after;while(startNode!==endNode){next=startNode.nextSibling;frag.appendChild(startNode);startNode=next}startContainer=common;startOffset=endNode?indexOf.call(common.childNodes,endNode):common.childNodes.length;after=common.childNodes[startOffset];before=after&&after.previousSibling;if(before&&before.nodeType===TEXT_NODE&&after.nodeType===TEXT_NODE){startContainer=before;startOffset=before.length;before.appendData(after.data);detach(after)}range.setStart(startContainer,startOffset);range.collapse(true);fixCursor(common);return frag};var deleteContentsOfRange=function(range){moveRangeBoundariesUpTree(range);extractContentsOfRange(range);moveRangeBoundariesDownTree(range);var startBlock=getStartBlockOfRange(range),endBlock=getEndBlockOfRange(range);if(startBlock&&endBlock&&startBlock!==endBlock){mergeWithBlock(startBlock,endBlock,range)}if(startBlock){fixCursor(startBlock)}var body=range.endContainer.ownerDocument.body,child=body.firstChild;if(!child||child.nodeName==="BR"||child.nodeName==="WBR"){fixCursor(body);range.selectNodeContents(body.firstChild)}};var insertTreeFragmentIntoRange=function(range,frag){var allInline=true,children=frag.childNodes,l=children.length;while(l--){if(!isInline(children[l])){allInline=false;break}}if(!range.collapsed){deleteContentsOfRange(range)}moveRangeBoundariesDownTree(range);if(allInline){insertNodeInRange(range,frag);range.collapse(false)}else{var block=getStartBlockOfRange(range);removeZWS(block);removeEmptyInlines(block);fixCursor(block);var splitPoint=range.startContainer,nodeAfterSplit=split(splitPoint,range.startOffset,getNearest(splitPoint.parentNode,"BLOCKQUOTE")||splitPoint.ownerDocument.body),nodeBeforeSplit=nodeAfterSplit.previousSibling,startContainer=nodeBeforeSplit,startOffset=startContainer.childNodes.length,endContainer=nodeAfterSplit,endOffset=0,parent=nodeAfterSplit.parentNode,child,node;while((child=startContainer.lastChild)&&child.nodeType===ELEMENT_NODE&&child.nodeName!=="BR"&&child.nodeName!=="WBR"){startContainer=child;startOffset=startContainer.childNodes.length}while((child=endContainer.firstChild)&&child.nodeType===ELEMENT_NODE&&child.nodeName!=="BR"&&child.nodeName!=="WBR"){endContainer=child}while((child=frag.firstChild)&&isInline(child)){startContainer.appendChild(child)}while((child=frag.lastChild)&&isInline(child)){endContainer.insertBefore(child,endContainer.firstChild);endOffset+=1}node=frag;while(node=getNextBlock(node)){fixCursor(node)}parent.insertBefore(frag,nodeAfterSplit);node=nodeAfterSplit.previousSibling;if(!nodeAfterSplit.textContent){parent.removeChild(nodeAfterSplit)}else{mergeContainers(nodeAfterSplit)}if(!nodeAfterSplit.parentNode){endContainer=node;endOffset=getLength(endContainer)}if(!nodeBeforeSplit.textContent){startContainer=nodeBeforeSplit.nextSibling;startOffset=0;parent.removeChild(nodeBeforeSplit)}else{mergeContainers(nodeBeforeSplit)}range.setStart(startContainer,startOffset);range.setEnd(endContainer,endOffset);moveRangeBoundariesDownTree(range)}};function getLastTextNode(node){var child=node.lastChild;while(child){if(child.nodeType===TEXT_NODE){return child}var text=getLastTextNode(child);if(text){return text}child=child.previousSibling}}var isNodeContainedInRange=function(range,node,partial){var nodeRange=node.ownerDocument.createRange();nodeRange.selectNode(node);if(partial){var nodeEndBeforeStart=range.compareBoundaryPoints(END_TO_START,nodeRange)>-1,nodeStartAfterEnd=range.compareBoundaryPoints(START_TO_END,nodeRange)<1;return!nodeEndBeforeStart&&!nodeStartAfterEnd}else{var nodeStartAfterStart=range.compareBoundaryPoints(START_TO_START,nodeRange)<1,nodeEndBeforeEnd=range.compareBoundaryPoints(END_TO_END,nodeRange)>-1;return nodeStartAfterStart&&nodeEndBeforeEnd}};var moveRangeBoundariesDownTree=function(range){var startContainer=range.startContainer,startOffset=range.startOffset,endContainer=range.endContainer,endOffset=range.endOffset,child;while(startContainer.nodeType!==TEXT_NODE){child=startContainer.childNodes[startOffset];if(!child||isLeaf(child)){break}startContainer=child;startOffset=0}if(endOffset){while(endContainer.nodeType!==TEXT_NODE){child=endContainer.childNodes[endOffset-1];if(!child||isLeaf(child)){break}endContainer=child;endOffset=getLength(endContainer)}}else{while(endContainer.nodeType!==TEXT_NODE){child=endContainer.firstChild;if(!child||isLeaf(child)){break}endContainer=child}}if(range.collapsed){range.setStart(endContainer,endOffset);range.setEnd(startContainer,startOffset)}else{range.setStart(startContainer,startOffset);range.setEnd(endContainer,endOffset)}};var moveRangeBoundariesUpTree=function(range,common){var startContainer=range.startContainer,startOffset=range.startOffset,endContainer=range.endContainer,endOffset=range.endOffset,parent;if(!common){common=range.commonAncestorContainer}while(startContainer!==common&&!startOffset){parent=startContainer.parentNode;startOffset=indexOf.call(parent.childNodes,startContainer);startContainer=parent}while(endContainer!==common&&endOffset===getLength(endContainer)){parent=endContainer.parentNode;endOffset=indexOf.call(parent.childNodes,endContainer)+1;endContainer=parent}range.setStart(startContainer,startOffset);range.setEnd(endContainer,endOffset)};var getStartBlockOfRange=function(range){var container=range.startContainer,block;if(isInline(container)){block=getPreviousBlock(container)}else if(isBlock(container)){block=container}else{block=getNodeBefore(container,range.startOffset);block=getNextBlock(block)}return block&&isNodeContainedInRange(range,block,true)?block:null};var getEndBlockOfRange=function(range){var container=range.endContainer,block,child;if(isInline(container)){block=getPreviousBlock(container)}else if(isBlock(container)){block=container}else{block=getNodeAfter(container,range.endOffset);if(!block){block=container.ownerDocument.body;while(child=block.lastChild){block=child}}block=getPreviousBlock(block)}return block&&isNodeContainedInRange(range,block,true)?block:null};var contentWalker=new TreeWalker(null,SHOW_TEXT|SHOW_ELEMENT,function(node){return node.nodeType===TEXT_NODE?notWS.test(node.data):node.nodeName==="IMG"});var rangeDoesStartAtBlockBoundary=function(range){var startContainer=range.startContainer,startOffset=range.startOffset;if(startContainer.nodeType===TEXT_NODE){if(startOffset){return false}contentWalker.currentNode=startContainer}else{contentWalker.currentNode=getNodeAfter(startContainer,startOffset)}contentWalker.root=getStartBlockOfRange(range);return!contentWalker.previousNode()};var rangeDoesEndAtBlockBoundary=function(range){var endContainer=range.endContainer,endOffset=range.endOffset,length;if(endContainer.nodeType===TEXT_NODE){length=endContainer.data.length;if(length&&endOffset<length){return false}contentWalker.currentNode=endContainer}else{contentWalker.currentNode=getNodeBefore(endContainer,endOffset)}contentWalker.root=getEndBlockOfRange(range);return!contentWalker.nextNode()};var expandRangeToBlockBoundaries=function(range){var start=getStartBlockOfRange(range),end=getEndBlockOfRange(range),parent;if(start&&end){parent=start.parentNode;range.setStart(parent,indexOf.call(parent.childNodes,start));parent=end.parentNode;range.setEnd(parent,indexOf.call(parent.childNodes,end)+1)}};var instances=[];function getSquireInstance(doc){var l=instances.length,instance;while(l--){instance=instances[l];if(instance._doc===doc){return instance}}return null}function Squire(doc){var win=doc.defaultView;var body=doc.body;var mutation;this._win=win;this._doc=doc;this._body=body;this._events={};this._sel=win.getSelection();this._lastSelection=null;if(losesSelectionOnBlur){this.addEventListener("beforedeactivate",this.getSelection)}this._hasZWS=false;this._lastAnchorNode=null;this._lastFocusNode=null;this._path="";this.addEventListener("keyup",this._updatePathOnEvent);this.addEventListener("mouseup",this._updatePathOnEvent);win.addEventListener("focus",this,false);win.addEventListener("blur",this,false);this._undoIndex=-1;this._undoStack=[];this._undoStackLength=0;this._isInUndoState=false;this._ignoreChange=false;if(canObserveMutations){mutation=new MutationObserver(this._docWasChanged.bind(this));mutation.observe(body,{childList:true,attributes:true,characterData:true,subtree:true});this._mutation=mutation}else{this.addEventListener("keyup",this._keyUpDetectChange)}this.defaultBlockTag="DIV";this.defaultBlockProperties=null;this._awaitingPaste=false;this.addEventListener(isIElt11?"beforecut":"cut",this._onCut);this.addEventListener(isIElt11?"beforepaste":"paste",this._onPaste);this.addEventListener(isPresto?"keypress":"keydown",this._onKey);if(isIElt11){win.Text.prototype.splitText=function(offset){var afterSplit=this.ownerDocument.createTextNode(this.data.slice(offset)),next=this.nextSibling,parent=this.parentNode,toDelete=this.length-offset;if(next){parent.insertBefore(afterSplit,next)}else{parent.appendChild(afterSplit)}if(toDelete){this.deleteData(offset,toDelete)}return afterSplit}}body.setAttribute("contenteditable","true");this.setHTML("");try{doc.execCommand("enableObjectResizing",false,"false");doc.execCommand("enableInlineTableEditing",false,"false")}catch(error){}instances.push(this)}var proto=Squire.prototype;proto.createElement=function(tag,props,children){return createElement(this._doc,tag,props,children)};proto.createDefaultBlock=function(children){return fixCursor(this.createElement(this.defaultBlockTag,this.defaultBlockProperties,children))};proto.didError=function(error){console.log(error)};proto.getDocument=function(){return this._doc};var customEvents={focus:1,blur:1,pathChange:1,select:1,input:1,undoStateChange:1};proto.fireEvent=function(type,event){var handlers=this._events[type],i,l,obj;if(handlers){if(!event){event={}}if(event.type!==type){event.type=type}handlers=handlers.slice();for(i=0,l=handlers.length;i<l;i+=1){obj=handlers[i];try{if(obj.handleEvent){obj.handleEvent(event)}else{obj.call(this,event)}}catch(error){error.details="Squire: fireEvent error. Event type: "+type;this.didError(error)}}}return this};proto.destroy=function(){var win=this._win,doc=this._doc,events=this._events,type;win.removeEventListener("focus",this,false);win.removeEventListener("blur",this,false);for(type in events){if(!customEvents[type]){doc.removeEventListener(type,this,true)}}if(this._mutation){this._mutation.disconnect()}var l=instances.length;while(l--){if(instances[l]===this){instances.splice(l,1)}}};proto.handleEvent=function(event){this.fireEvent(event.type,event)};proto.addEventListener=function(type,fn){var handlers=this._events[type];if(!fn){this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+type});return this}if(!handlers){handlers=this._events[type]=[];if(!customEvents[type]){this._doc.addEventListener(type,this,true)}}handlers.push(fn);return this};proto.removeEventListener=function(type,fn){var handlers=this._events[type],l;if(handlers){l=handlers.length;while(l--){if(handlers[l]===fn){handlers.splice(l,1)}}if(!handlers.length){delete this._events[type];if(!customEvents[type]){this._doc.removeEventListener(type,this,false)}}}return this};proto._createRange=function(range,startOffset,endContainer,endOffset){if(range instanceof this._win.Range){return range.cloneRange()}var domRange=this._doc.createRange();domRange.setStart(range,startOffset);if(endContainer){domRange.setEnd(endContainer,endOffset)}else{domRange.setEnd(range,startOffset)}return domRange};proto.setSelection=function(range){if(range){if(isIOS){this._win.focus()}var sel=this._sel;sel.removeAllRanges();sel.addRange(range)}return this};proto.getSelection=function(){var sel=this._sel,selection,startContainer,endContainer;if(sel.rangeCount){selection=sel.getRangeAt(0).cloneRange();startContainer=selection.startContainer;endContainer=selection.endContainer;if(startContainer&&isLeaf(startContainer)){selection.setStartBefore(startContainer)}if(endContainer&&isLeaf(endContainer)){selection.setEndBefore(endContainer)}this._lastSelection=selection}else{selection=this._lastSelection}if(!selection){selection=this._createRange(this._body.firstChild,0)}return selection};proto.getSelectedText=function(){var range=this.getSelection(),walker=new TreeWalker(range.commonAncestorContainer,SHOW_TEXT|SHOW_ELEMENT,function(node){return isNodeContainedInRange(range,node,true)}),startContainer=range.startContainer,endContainer=range.endContainer,node=walker.currentNode=startContainer,textContent="",addedTextInBlock=false,value;if(!walker.filter(node)){node=walker.nextNode()}while(node){if(node.nodeType===TEXT_NODE){value=node.data;if(value&&/\S/.test(value)){if(node===endContainer){value=value.slice(0,range.endOffset)}if(node===startContainer){value=value.slice(range.startOffset)}textContent+=value;addedTextInBlock=true}}else if(node.nodeName==="BR"||addedTextInBlock&&!isInline(node)){textContent+="\n";addedTextInBlock=false}node=walker.nextNode()}return textContent};proto.getPath=function(){return this._path};var removeZWS=function(root){var walker=new TreeWalker(root,SHOW_TEXT,function(){return true},false),parent,node,index;while(node=walker.nextNode()){while((index=node.data.indexOf(ZWS))>-1){if(node.length===1){do{parent=node.parentNode;parent.removeChild(node);node=parent}while(isInline(node)&&!getLength(node));break}else{node.deleteData(index,1)}}}};proto._didAddZWS=function(){this._hasZWS=true};proto._removeZWS=function(){if(!this._hasZWS){return}removeZWS(this._body);this._hasZWS=false};proto._updatePath=function(range,force){var anchor=range.startContainer,focus=range.endContainer,newPath;if(force||anchor!==this._lastAnchorNode||focus!==this._lastFocusNode){this._lastAnchorNode=anchor;this._lastFocusNode=focus;newPath=anchor&&focus?anchor===focus?getPath(focus):"(selection)":"";if(this._path!==newPath){this._path=newPath;this.fireEvent("pathChange",{path:newPath})}}this.fireEvent("select")};proto._updatePathOnEvent=function(){this._updatePath(this.getSelection())};proto.focus=function(){if(!isPresto){this._body.focus()}this._win.focus();return this};proto.blur=function(){if(isGecko){this._body.blur()}top.focus();return this};var startSelectionId="squire-selection-start";var endSelectionId="squire-selection-end";proto._saveRangeToBookmark=function(range){var startNode=this.createElement("INPUT",{id:startSelectionId,type:"hidden"}),endNode=this.createElement("INPUT",{id:endSelectionId,type:"hidden"}),temp;insertNodeInRange(range,startNode);range.collapse(false);insertNodeInRange(range,endNode);if(startNode.compareDocumentPosition(endNode)&DOCUMENT_POSITION_PRECEDING){startNode.id=endSelectionId;endNode.id=startSelectionId;temp=startNode;startNode=endNode;endNode=temp}range.setStartAfter(startNode);range.setEndBefore(endNode)};proto._getRangeAndRemoveBookmark=function(range){var doc=this._doc,start=doc.getElementById(startSelectionId),end=doc.getElementById(endSelectionId);if(start&&end){var startContainer=start.parentNode,endContainer=end.parentNode,collapsed;var _range={startContainer:startContainer,endContainer:endContainer,startOffset:indexOf.call(startContainer.childNodes,start),endOffset:indexOf.call(endContainer.childNodes,end)};if(startContainer===endContainer){_range.endOffset-=1}detach(start);detach(end);mergeInlines(startContainer,_range);if(startContainer!==endContainer){mergeInlines(endContainer,_range)}if(!range){range=doc.createRange()}range.setStart(_range.startContainer,_range.startOffset);range.setEnd(_range.endContainer,_range.endOffset);collapsed=range.collapsed;moveRangeBoundariesDownTree(range);if(collapsed){range.collapse(true)}}return range||null};proto._keyUpDetectChange=function(event){var code=event.keyCode;if(!event.ctrlKey&&!event.metaKey&&!event.altKey&&(code<16||code>20)&&(code<33||code>45)){this._docWasChanged()}};proto._docWasChanged=function(){if(canObserveMutations&&this._ignoreChange){this._ignoreChange=false;return}if(this._isInUndoState){this._isInUndoState=false;this.fireEvent("undoStateChange",{canUndo:true,canRedo:false})}this.fireEvent("input")};proto._recordUndoState=function(range){if(!this._isInUndoState){var undoIndex=this._undoIndex+=1,undoStack=this._undoStack;if(undoIndex<this._undoStackLength){undoStack.length=this._undoStackLength=undoIndex}if(range){this._saveRangeToBookmark(range)}undoStack[undoIndex]=this._getHTML();this._undoStackLength+=1;this._isInUndoState=true}};proto.undo=function(){if(this._undoIndex!==0||!this._isInUndoState){this._recordUndoState(this.getSelection());this._undoIndex-=1;this._setHTML(this._undoStack[this._undoIndex]);var range=this._getRangeAndRemoveBookmark();if(range){this.setSelection(range)}this._isInUndoState=true;this.fireEvent("undoStateChange",{canUndo:this._undoIndex!==0,canRedo:true});this.fireEvent("input")}return this};proto.redo=function(){var undoIndex=this._undoIndex,undoStackLength=this._undoStackLength;if(undoIndex+1<undoStackLength&&this._isInUndoState){this._undoIndex+=1;this._setHTML(this._undoStack[this._undoIndex]);var range=this._getRangeAndRemoveBookmark();if(range){this.setSelection(range)}this.fireEvent("undoStateChange",{canUndo:true,canRedo:undoIndex+2<undoStackLength});this.fireEvent("input")}return this};proto.hasFormat=function(tag,attributes,range){tag=tag.toUpperCase();if(!attributes){attributes={}}if(!range&&!(range=this.getSelection())){return false}var root=range.commonAncestorContainer,walker,node;if(getNearest(root,tag,attributes)){return true}if(root.nodeType===TEXT_NODE){return false}walker=new TreeWalker(root,SHOW_TEXT,function(node){return isNodeContainedInRange(range,node,true)},false);var seenNode=false;while(node=walker.nextNode()){if(!getNearest(node,tag,attributes)){return false}seenNode=true}return seenNode};proto._addFormat=function(tag,attributes,range){var el,walker,startContainer,endContainer,startOffset,endOffset,node,needsFormat;if(range.collapsed){el=fixCursor(this.createElement(tag,attributes));insertNodeInRange(range,el);range.setStart(el.firstChild,el.firstChild.length);range.collapse(true)}else{walker=new TreeWalker(range.commonAncestorContainer,SHOW_TEXT|SHOW_ELEMENT,function(node){return(node.nodeType===TEXT_NODE||node.nodeName==="BR")&&isNodeContainedInRange(range,node,true)},false);startContainer=range.startContainer;startOffset=range.startOffset;endContainer=range.endContainer;endOffset=range.endOffset;walker.currentNode=startContainer;if(!walker.filter(startContainer)){startContainer=walker.nextNode();startOffset=0}if(!startContainer){return range}do{node=walker.currentNode;needsFormat=!getNearest(node,tag,attributes);if(needsFormat){if(node===endContainer&&node.length>endOffset){node.splitText(endOffset)}if(node===startContainer&&startOffset){node=node.splitText(startOffset);if(endContainer===startContainer){endContainer=node;endOffset-=startOffset}startContainer=node;startOffset=0}el=this.createElement(tag,attributes);replaceWith(node,el);el.appendChild(node)}}while(walker.nextNode());if(endContainer.nodeType!==TEXT_NODE){if(node.nodeType===TEXT_NODE){endContainer=node;endOffset=node.length}else{endContainer=node.parentNode;endOffset=1}}range=this._createRange(startContainer,startOffset,endContainer,endOffset)}return range};proto._removeFormat=function(tag,attributes,range,partial){this._saveRangeToBookmark(range);var doc=this._doc,fixer;if(range.collapsed){if(cantFocusEmptyTextNodes){fixer=doc.createTextNode(ZWS);this._didAddZWS()}else{fixer=doc.createTextNode("")}insertNodeInRange(range,fixer)}var root=range.commonAncestorContainer;while(isInline(root)){root=root.parentNode}var startContainer=range.startContainer,startOffset=range.startOffset,endContainer=range.endContainer,endOffset=range.endOffset,toWrap=[],examineNode=function(node,exemplar){if(isNodeContainedInRange(range,node,false)){return}var isText=node.nodeType===TEXT_NODE,child,next;if(!isNodeContainedInRange(range,node,true)){if(node.nodeName!=="INPUT"&&(!isText||node.data)){toWrap.push([exemplar,node])}return}if(isText){if(node===endContainer&&endOffset!==node.length){toWrap.push([exemplar,node.splitText(endOffset)])}if(node===startContainer&&startOffset){node.splitText(startOffset);toWrap.push([exemplar,node])}}else{for(child=node.firstChild;child;child=next){next=child.nextSibling;examineNode(child,exemplar)}}},formatTags=Array.prototype.filter.call(root.getElementsByTagName(tag),function(el){return isNodeContainedInRange(range,el,true)&&hasTagAttributes(el,tag,attributes)});if(!partial){formatTags.forEach(function(node){examineNode(node,node)})}toWrap.forEach(function(item){var el=item[0].cloneNode(false),node=item[1];

replaceWith(node,el);el.appendChild(node)});formatTags.forEach(function(el){replaceWith(el,empty(el))});this._getRangeAndRemoveBookmark(range);if(fixer){range.collapse(false)}var _range={startContainer:range.startContainer,startOffset:range.startOffset,endContainer:range.endContainer,endOffset:range.endOffset};mergeInlines(root,_range);range.setStart(_range.startContainer,_range.startOffset);range.setEnd(_range.endContainer,_range.endOffset);return range};proto.changeFormat=function(add,remove,range,partial){if(!range&&!(range=this.getSelection())){return}this._recordUndoState(range);this._getRangeAndRemoveBookmark(range);if(remove){range=this._removeFormat(remove.tag.toUpperCase(),remove.attributes||{},range,partial)}if(add){range=this._addFormat(add.tag.toUpperCase(),add.attributes||{},range)}this.setSelection(range);this._updatePath(range,true);if(!canObserveMutations){this._docWasChanged()}return this};var tagAfterSplit={DT:"DD",DD:"DT",LI:"LI"};var splitBlock=function(self,block,node,offset){var splitTag=tagAfterSplit[block.nodeName],splitProperties=null,nodeAfterSplit=split(node,offset,block.parentNode);if(!splitTag){splitTag=self.defaultBlockTag;splitProperties=self.defaultBlockProperties}if(!hasTagAttributes(nodeAfterSplit,splitTag,splitProperties)){block=createElement(nodeAfterSplit.ownerDocument,splitTag,splitProperties);if(nodeAfterSplit.dir){block.className=nodeAfterSplit.dir==="rtl"?"dir-rtl":"";block.dir=nodeAfterSplit.dir}replaceWith(nodeAfterSplit,block);block.appendChild(empty(nodeAfterSplit));nodeAfterSplit=block}return nodeAfterSplit};proto.forEachBlock=function(fn,mutates,range){if(!range&&!(range=this.getSelection())){return this}if(mutates){this._recordUndoState(range);this._getRangeAndRemoveBookmark(range)}var start=getStartBlockOfRange(range),end=getEndBlockOfRange(range);if(start&&end){do{if(fn(start)||start===end){break}}while(start=getNextBlock(start))}if(mutates){this.setSelection(range);this._updatePath(range,true);if(!canObserveMutations){this._docWasChanged()}}return this};proto.modifyBlocks=function(modify,range){if(!range&&!(range=this.getSelection())){return this}if(this._isInUndoState){this._saveRangeToBookmark(range)}else{this._recordUndoState(range)}expandRangeToBlockBoundaries(range);var body=this._body,frag;moveRangeBoundariesUpTree(range,body);frag=extractContentsOfRange(range,body);insertNodeInRange(range,modify.call(this,frag));if(range.endOffset<range.endContainer.childNodes.length){mergeContainers(range.endContainer.childNodes[range.endOffset])}mergeContainers(range.startContainer.childNodes[range.startOffset]);this._getRangeAndRemoveBookmark(range);this.setSelection(range);this._updatePath(range,true);if(!canObserveMutations){this._docWasChanged()}return this};var increaseBlockQuoteLevel=function(frag){return this.createElement("BLOCKQUOTE",[frag])};var decreaseBlockQuoteLevel=function(frag){var blockquotes=frag.querySelectorAll("blockquote");Array.prototype.filter.call(blockquotes,function(el){return!getNearest(el.parentNode,"BLOCKQUOTE")}).forEach(function(el){replaceWith(el,empty(el))});return frag};var removeBlockQuote=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:startSelectionId,type:"hidden"}),this.createElement("INPUT",{id:endSelectionId,type:"hidden"})])};var makeList=function(self,frag,type){var walker=getBlockWalker(frag),node,tag,prev,newLi;while(node=walker.nextNode()){tag=node.parentNode.nodeName;if(tag!=="LI"){newLi=self.createElement("LI",{"class":node.dir==="rtl"?"dir-rtl":undefined,dir:node.dir||undefined});if((prev=node.previousSibling)&&prev.nodeName===type){prev.appendChild(newLi)}else{replaceWith(node,self.createElement(type,[newLi]))}newLi.appendChild(node)}else{node=node.parentNode.parentNode;tag=node.nodeName;if(tag!==type&&/^[OU]L$/.test(tag)){replaceWith(node,self.createElement(type,[empty(node)]))}}}};var makeUnorderedList=function(frag){makeList(this,frag,"UL");return frag};var makeOrderedList=function(frag){makeList(this,frag,"OL");return frag};var removeList=function(frag){var lists=frag.querySelectorAll("UL, OL"),i,l,ll,list,listFrag,children,child;for(i=0,l=lists.length;i<l;i+=1){list=lists[i];listFrag=empty(list);children=listFrag.childNodes;ll=children.length;while(ll--){child=children[ll];replaceWith(child,empty(child))}fixContainer(listFrag);replaceWith(list,listFrag)}return frag};var increaseListLevel=function(frag){var items=frag.querySelectorAll("LI"),i,l,item,type,newParent;for(i=0,l=items.length;i<l;i+=1){item=items[i];if(!isContainer(item.firstChild)){type=item.parentNode.nodeName;newParent=item.previousSibling;if(!newParent||!(newParent=newParent.lastChild)||newParent.nodeName!==type){replaceWith(item,this.createElement("LI",[newParent=this.createElement(type)]))}newParent.appendChild(item)}}return frag};var decreaseListLevel=function(frag){var items=frag.querySelectorAll("LI");Array.prototype.filter.call(items,function(el){return!isContainer(el.firstChild)}).forEach(function(item){var parent=item.parentNode,newParent=parent.parentNode,first=item.firstChild,node=first,next;if(item.previousSibling){parent=split(parent,item,newParent)}while(node){next=node.nextSibling;if(isContainer(node)){break}newParent.insertBefore(node,parent);node=next}if(newParent.nodeName==="LI"&&first.previousSibling){split(newParent,first,newParent.parentNode)}while(item!==frag&&!item.childNodes.length){parent=item.parentNode;parent.removeChild(item);item=parent}},this);fixContainer(frag);return frag};var linkRegExp=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i;var addLinks=function(frag){var doc=frag.ownerDocument,walker=new TreeWalker(frag,SHOW_TEXT,function(node){return!getNearest(node,"A")},false),node,data,parent,match,index,endIndex,child;while(node=walker.nextNode()){data=node.data;parent=node.parentNode;while(match=linkRegExp.exec(data)){index=match.index;endIndex=index+match[0].length;if(index){child=doc.createTextNode(data.slice(0,index));parent.insertBefore(child,node)}child=doc.createElement("A");child.textContent=data.slice(index,endIndex);child.href=match[1]?/^(?:ht|f)tps?:/.test(match[1])?match[1]:"http://"+match[1]:"mailto:"+match[2];parent.insertBefore(child,node);node.data=data=data.slice(endIndex)}}};var allowedBlock=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|UL)$/;var fontSizes={1:10,2:13,3:16,4:18,5:24,6:32,7:48};var spanToSemantic={backgroundColor:{regexp:notWS,replace:function(doc,colour){return createElement(doc,"SPAN",{"class":"highlight",style:"background-color: "+colour})}},color:{regexp:notWS,replace:function(doc,colour){return createElement(doc,"SPAN",{"class":"colour",style:"color:"+colour})}},fontWeight:{regexp:/^bold/i,replace:function(doc){return createElement(doc,"B")}},fontStyle:{regexp:/^italic/i,replace:function(doc){return createElement(doc,"I")}},fontFamily:{regexp:notWS,replace:function(doc,family){return createElement(doc,"SPAN",{"class":"font",style:"font-family:"+family})}},fontSize:{regexp:notWS,replace:function(doc,size){return createElement(doc,"SPAN",{"class":"size",style:"font-size:"+size})}}};var replaceWithTag=function(tag){return function(node,parent){var el=createElement(node.ownerDocument,tag);parent.replaceChild(el,node);el.appendChild(empty(node));return el}};var stylesRewriters={SPAN:function(span,parent){var style=span.style,doc=span.ownerDocument,attr,converter,css,newTreeBottom,newTreeTop,el;for(attr in spanToSemantic){converter=spanToSemantic[attr];css=style[attr];if(css&&converter.regexp.test(css)){el=converter.replace(doc,css);if(newTreeBottom){newTreeBottom.appendChild(el)}newTreeBottom=el;if(!newTreeTop){newTreeTop=el}}}if(newTreeTop){newTreeBottom.appendChild(empty(span));parent.replaceChild(newTreeTop,span)}return newTreeBottom||span},STRONG:replaceWithTag("B"),EM:replaceWithTag("I"),STRIKE:replaceWithTag("S"),FONT:function(node,parent){var face=node.face,size=node.size,colour=node.color,doc=node.ownerDocument,fontSpan,sizeSpan,colourSpan,newTreeBottom,newTreeTop;if(face){fontSpan=createElement(doc,"SPAN",{"class":"font",style:"font-family:"+face});newTreeTop=fontSpan;newTreeBottom=fontSpan}if(size){sizeSpan=createElement(doc,"SPAN",{"class":"size",style:"font-size:"+fontSizes[size]+"px"});if(!newTreeTop){newTreeTop=sizeSpan}if(newTreeBottom){newTreeBottom.appendChild(sizeSpan)}newTreeBottom=sizeSpan}if(colour&&/^#?([\dA-F]{3}){1,2}$/i.test(colour)){if(colour.charAt(0)!=="#"){colour="#"+colour}colourSpan=createElement(doc,"SPAN",{"class":"colour",style:"color:"+colour});if(!newTreeTop){newTreeTop=colourSpan}if(newTreeBottom){newTreeBottom.appendChild(colourSpan)}newTreeBottom=colourSpan}if(!newTreeTop){newTreeTop=newTreeBottom=createElement(doc,"SPAN")}parent.replaceChild(newTreeTop,node);newTreeBottom.appendChild(empty(node));return newTreeBottom},TT:function(node,parent){var el=createElement(node.ownerDocument,"SPAN",{"class":"font",style:'font-family:menlo,consolas,"courier new",monospace'});parent.replaceChild(el,node);el.appendChild(empty(node));return el}};var removeEmptyInlines=function(root){var children=root.childNodes,l=children.length,child;while(l--){child=children[l];if(child.nodeType===ELEMENT_NODE&&!isLeaf(child)){removeEmptyInlines(child);if(isInline(child)&&!child.firstChild){root.removeChild(child)}}else if(child.nodeType===TEXT_NODE&&!child.data){root.removeChild(child)}}};var cleanTree=function(node,allowStyles){var children=node.childNodes,i,l,child,nodeName,nodeType,rewriter,childLength,data,j,ll;for(i=0,l=children.length;i<l;i+=1){child=children[i];nodeName=child.nodeName;nodeType=child.nodeType;rewriter=stylesRewriters[nodeName];if(nodeType===ELEMENT_NODE){childLength=child.childNodes.length;if(rewriter){child=rewriter(child,node)}else if(!allowedBlock.test(nodeName)&&!isInline(child)){i-=1;l+=childLength-1;node.replaceChild(empty(child),child);continue}else if(!allowStyles&&child.style.cssText){child.removeAttribute("style")}if(childLength){cleanTree(child,allowStyles)}}else{if(nodeType===TEXT_NODE){data=child.data;if(/\S/.test(data)){if(isInline(node)){continue}j=0;ll=data.length;if(!i||!isInline(children[i-1])){while(j<ll&&!notWS.test(data.charAt(j))){j+=1}if(j){child.data=data=data.slice(j);ll-=j}}if(i+1===l||!isInline(children[i+1])){j=ll;while(j>0&&!notWS.test(data.charAt(j-1))){j-=1}if(j<ll){child.data=data.slice(0,j)}}continue}else if(i&&i+1<l&&isInline(children[i-1])&&isInline(children[i+1])){child.data=" ";continue}}node.removeChild(child);i-=1;l-=1}}return node};var notWSTextNode=function(node){return node.nodeType===ELEMENT_NODE?node.nodeName==="BR"||node.nodeName==="WBR":notWS.test(node.data)};var isLineBreak=function(br){var block=br.parentNode,walker;while(isInline(block)){block=block.parentNode}walker=new TreeWalker(block,SHOW_ELEMENT|SHOW_TEXT,notWSTextNode);walker.currentNode=br;return!!walker.nextNode()};var cleanupBRs=function(root){var brs=root.querySelectorAll("BR"),brBreaksLine=[],l=brs.length,i,br,block;for(i=0;i<l;i+=1){brBreaksLine[i]=isLineBreak(brs[i])}while(l--){br=brs[l];block=br.parentNode;if(!block){continue}while(isInline(block)){block=block.parentNode}if(!isBlock(block)){fixContainer(block)}else{if(brBreaksLine[l]){if(block.nodeName!=="DIV"){continue}split(br.parentNode,br,block.parentNode)}detach(br)}}var wbrs=root.querySelectorAll("WBR"),wl=wbrs.length,wbr;while(wl--){wbr=wbrs[wl];detach(wbr)}};proto._ensureBottomLine=function(){var body=this._body,last=body.lastElementChild;if(!last||last.nodeName!==this.defaultBlockTag||!isBlock(last)){body.appendChild(this.createDefaultBlock())}};proto._onCut=function(){var range=this.getSelection();var self=this;this._recordUndoState(range);this._getRangeAndRemoveBookmark(range);this.setSelection(range);setTimeout(function(){try{self._ensureBottomLine()}catch(error){self.didError(error)}},0)};proto._onPaste=function(event){if(this._awaitingPaste){return}var clipboardData=event.clipboardData,items=clipboardData&&clipboardData.items,fireDrop=false,hasImage=false,l,type;if(items){l=items.length;while(l--){type=items[l].type;if(type==="text/html"){hasImage=false;break}if(/^image\/.*/.test(type)){hasImage=true}}if(hasImage){event.preventDefault();this.fireEvent("dragover",{dataTransfer:clipboardData,preventDefault:function(){fireDrop=true}});if(fireDrop){this.fireEvent("drop",{dataTransfer:clipboardData})}return}}this._awaitingPaste=true;var self=this,body=this._body,range=this.getSelection(),startContainer,startOffset,endContainer,endOffset,startBlock;self._recordUndoState(range);self._getRangeAndRemoveBookmark(range);startContainer=range.startContainer;startOffset=range.startOffset;endContainer=range.endContainer;endOffset=range.endOffset;startBlock=getStartBlockOfRange(range);var pasteArea=this.createElement("DIV",{style:"position: absolute; overflow: hidden; top:"+(body.scrollTop+(startBlock?startBlock.getBoundingClientRect().top:0))+"px; left: 0; width: 1px; height: 1px;"});body.appendChild(pasteArea);range.selectNodeContents(pasteArea);this.setSelection(range);setTimeout(function(){try{var frag=empty(detach(pasteArea)),first=frag.firstChild,range=self._createRange(startContainer,startOffset,endContainer,endOffset);if(first){if(first===frag.lastChild&&first.nodeName==="DIV"){frag.replaceChild(empty(first),first)}frag.normalize();addLinks(frag);cleanTree(frag,false);cleanupBRs(frag);removeEmptyInlines(frag);var node=frag,doPaste=true;while(node=getNextBlock(node)){fixCursor(node)}self.fireEvent("willPaste",{fragment:frag,preventDefault:function(){doPaste=false}});if(doPaste){insertTreeFragmentIntoRange(range,frag);if(!canObserveMutations){self._docWasChanged()}range.collapse(false);self._ensureBottomLine()}}self.setSelection(range);self._updatePath(range,true);self._awaitingPaste=false}catch(error){self.didError(error)}},0)};var keys={8:"backspace",9:"tab",13:"enter",32:"space",37:"left",39:"right",46:"delete",219:"[",221:"]"};var mapKeyTo=function(method){return function(self,event){event.preventDefault();self[method]()}};var mapKeyToFormat=function(tag,remove){remove=remove||null;return function(self,event){event.preventDefault();var range=self.getSelection();if(self.hasFormat(tag,null,range)){self.changeFormat(null,{tag:tag},range)}else{self.changeFormat({tag:tag},remove,range)}}};var afterDelete=function(self,range){try{if(!range){range=self.getSelection()}var node=range.startContainer,parent;if(node.nodeType===TEXT_NODE){node=node.parentNode}parent=node;while(isInline(parent)&&(!parent.textContent||parent.textContent===ZWS)){node=parent;parent=node.parentNode}if(node!==parent){range.setStart(parent,indexOf.call(parent.childNodes,node));range.collapse(true);parent.removeChild(node);if(!isBlock(parent)){parent=getPreviousBlock(parent)}fixCursor(parent);moveRangeBoundariesDownTree(range)}self._ensureBottomLine();self.setSelection(range);self._updatePath(range,true)}catch(error){self.didError(error)}};var keyHandlers={enter:function(self,event,range){var block,parent,nodeAfterSplit;event.preventDefault();self._recordUndoState(range);addLinks(range.startContainer);self._removeZWS();self._getRangeAndRemoveBookmark(range);if(!range.collapsed){deleteContentsOfRange(range)}block=getStartBlockOfRange(range);if(!block||/^T[HD]$/.test(block.nodeName)){insertNodeInRange(range,self.createElement("BR"));range.collapse(false);self.setSelection(range);self._updatePath(range,true);return}if(parent=getNearest(block,"LI")){block=parent}if(!block.textContent){if(getNearest(block,"UL")||getNearest(block,"OL")){return self.modifyBlocks(decreaseListLevel,range)}else if(getNearest(block,"BLOCKQUOTE")){return self.modifyBlocks(removeBlockQuote,range)}}nodeAfterSplit=splitBlock(self,block,range.startContainer,range.startOffset);removeZWS(block);removeEmptyInlines(block);fixCursor(block);while(nodeAfterSplit.nodeType===ELEMENT_NODE){var child=nodeAfterSplit.firstChild,next;if(nodeAfterSplit.nodeName==="A"&&(!nodeAfterSplit.textContent||nodeAfterSplit.textContent===ZWS)){child=self._doc.createTextNode("");replaceWith(nodeAfterSplit,child);nodeAfterSplit=child;break}while(child&&child.nodeType===TEXT_NODE&&!child.data){next=child.nextSibling;if(!next||next.nodeName==="BR"){break}detach(child);child=next}if(!child||child.nodeName==="BR"||child.nodeType===TEXT_NODE&&!isPresto){break}nodeAfterSplit=child}range=self._createRange(nodeAfterSplit,0);self.setSelection(range);self._updatePath(range,true);if(nodeAfterSplit.nodeType===TEXT_NODE){nodeAfterSplit=nodeAfterSplit.parentNode}var doc=self._doc,body=self._body;if(nodeAfterSplit.offsetTop+nodeAfterSplit.offsetHeight>(doc.documentElement.scrollTop||body.scrollTop)+body.offsetHeight){nodeAfterSplit.scrollIntoView(false)}},backspace:function(self,event,range){self._removeZWS();self._recordUndoState(range);self._getRangeAndRemoveBookmark(range);if(!range.collapsed){event.preventDefault();deleteContentsOfRange(range);afterDelete(self,range)}else if(rangeDoesStartAtBlockBoundary(range)){event.preventDefault();var current=getStartBlockOfRange(range),previous=current&&getPreviousBlock(current);if(previous){if(!previous.isContentEditable){detach(previous);return}mergeWithBlock(previous,current,range);current=previous.parentNode;while(current&&!current.nextSibling){current=current.parentNode}if(current&&(current=current.nextSibling)){mergeContainers(current)}self.setSelection(range)}else if(current){if(getNearest(current,"UL")||getNearest(current,"OL")){return self.modifyBlocks(decreaseListLevel,range)}else if(getNearest(current,"BLOCKQUOTE")){return self.modifyBlocks(decreaseBlockQuoteLevel,range)}self.setSelection(range);self._updatePath(range,true)}}else{self.setSelection(range);setTimeout(function(){afterDelete(self)},0)}},"delete":function(self,event,range){self._removeZWS();self._recordUndoState(range);self._getRangeAndRemoveBookmark(range);if(!range.collapsed){event.preventDefault();deleteContentsOfRange(range);afterDelete(self,range)}else if(rangeDoesEndAtBlockBoundary(range)){event.preventDefault();var current=getStartBlockOfRange(range),next=current&&getNextBlock(current);if(next){if(!next.isContentEditable){detach(next);return}mergeWithBlock(current,next,range);next=current.parentNode;while(next&&!next.nextSibling){next=next.parentNode}if(next&&(next=next.nextSibling)){mergeContainers(next)}self.setSelection(range);self._updatePath(range,true)}}else{self.setSelection(range);setTimeout(function(){afterDelete(self)},0)}},tab:function(self,event,range){var node,parent;self._removeZWS();if(range.collapsed&&rangeDoesStartAtBlockBoundary(range)&&rangeDoesEndAtBlockBoundary(range)){node=getStartBlockOfRange(range);while(parent=node.parentNode){if(parent.nodeName==="UL"||parent.nodeName==="OL"){if(node.previousSibling){event.preventDefault();self.modifyBlocks(increaseListLevel,range)}break}node=parent}event.preventDefault()}},space:function(self,_,range){var node,parent;self._recordUndoState(range);addLinks(range.startContainer);self._getRangeAndRemoveBookmark(range);node=range.endContainer;parent=node.parentNode;if(range.collapsed&&parent.nodeName==="A"&&!node.nextSibling&&range.endOffset===getLength(node)){range.setStartAfter(parent)}self.setSelection(range)},left:function(self){self._removeZWS()},right:function(self){self._removeZWS()}};if(isMac&&isGecko&&win.getSelection().modify){keyHandlers["meta-left"]=function(self,event){event.preventDefault();self._sel.modify("move","backward","lineboundary")};keyHandlers["meta-right"]=function(self,event){event.preventDefault();self._sel.modify("move","forward","lineboundary")}}keyHandlers[ctrlKey+"b"]=mapKeyToFormat("B");keyHandlers[ctrlKey+"i"]=mapKeyToFormat("I");keyHandlers[ctrlKey+"u"]=mapKeyToFormat("U");keyHandlers[ctrlKey+"shift-7"]=mapKeyToFormat("S");keyHandlers[ctrlKey+"shift-5"]=mapKeyToFormat("SUB",{tag:"SUP"});keyHandlers[ctrlKey+"shift-6"]=mapKeyToFormat("SUP",{tag:"SUB"});keyHandlers[ctrlKey+"shift-8"]=mapKeyTo("makeUnorderedList");keyHandlers[ctrlKey+"shift-9"]=mapKeyTo("makeOrderedList");keyHandlers[ctrlKey+"["]=mapKeyTo("decreaseQuoteLevel");keyHandlers[ctrlKey+"]"]=mapKeyTo("increaseQuoteLevel");keyHandlers[ctrlKey+"y"]=mapKeyTo("redo");keyHandlers[ctrlKey+"z"]=mapKeyTo("undo");keyHandlers[ctrlKey+"shift-z"]=mapKeyTo("redo");proto._onKey=function(event){var code=event.keyCode,key=keys[code],modifiers="",range=this.getSelection();if(!key){key=String.fromCharCode(code).toLowerCase();if(!/^[A-Za-z0-9]$/.test(key)){key=""}}if(isPresto&&event.which===46){key="."}if(111<code&&code<124){key="f"+(code-111)}if(key!=="backspace"&&key!=="delete"){if(event.altKey){modifiers+="alt-"}if(event.ctrlKey){modifiers+="ctrl-"}if(event.metaKey){modifiers+="meta-"}}if(event.shiftKey){modifiers+="shift-"}key=modifiers+key;if(keyHandlers[key]){keyHandlers[key](this,event,range)}else if(key.length===1&&!range.collapsed){this._recordUndoState(range);this._getRangeAndRemoveBookmark(range);deleteContentsOfRange(range);this._ensureBottomLine();this.setSelection(range);this._updatePath(range,true)}};proto._getHTML=function(){return this._body.innerHTML};proto._setHTML=function(html){var node=this._body;node.innerHTML=html;do{fixCursor(node)}while(node=getNextBlock(node));this._ignoreChange=true};proto.getHTML=function(withBookMark){var brs=[],node,fixer,html,l,range;if(withBookMark&&(range=this.getSelection())){this._saveRangeToBookmark(range)}if(useTextFixer&&!useNonEmptyFixer){node=this._body;while(node=getNextBlock(node)){if(!node.textContent&&!node.querySelector("BR")){fixer=this.createElement("BR");node.appendChild(fixer);brs.push(fixer)}}}html=this._getHTML().replace(/\u200B/g,"").replace("/<wbr([^>]*/?[^>]*)>/g","");if(useTextFixer){l=brs.length;while(l--){detach(brs[l])}}if(range){this._getRangeAndRemoveBookmark(range)}return html};proto.setHTML=function(html){var frag=this._doc.createDocumentFragment(),div=this.createElement("DIV"),child;div.innerHTML=html;frag.appendChild(empty(div));cleanTree(frag,true);cleanupBRs(frag);fixContainer(frag);var node=frag;while(node=getNextBlock(node)){fixCursor(node)}this._ignoreChange=true;var body=this._body;while(child=body.lastChild){body.removeChild(child)}body.appendChild(frag);fixCursor(body);this._undoIndex=-1;this._undoStack.length=0;this._undoStackLength=0;this._isInUndoState=false;var range=this._getRangeAndRemoveBookmark()||this._createRange(body.firstChild,0);this._recordUndoState(range);this._getRangeAndRemoveBookmark(range);if(losesSelectionOnBlur){this._lastSelection=range}else{this.setSelection(range)}this._updatePath(range,true);return this};proto.insertElement=function(el,range){if(!range){range=this.getSelection()}this._recordUndoState(range);this._getRangeAndRemoveBookmark(range);if(!range.collapsed){deleteContentsOfRange(range);range.collapse(true)}if(isInline(el)){insertNodeInRange(range,el);range.setStartAfter(el)}else{var body=this._body,splitNode=getStartBlockOfRange(range),parent,nodeAfterSplit;if(splitNode){var currentText=splitNode.textContent;var isNewEmptyLine=splitNode.textContent===""||/^[\u200b]+$/.test(splitNode.textContent);if(isNewEmptyLine&&splitNode!==body){splitNode.parentNode.insertBefore(el,splitNode)}else{if(parent=getNearest(splitNode,"LI")){splitNode=parent}if(!splitNode.textContent){if(getNearest(splitNode,"UL")||getNearest(splitNode,"OL")){return self.modifyBlocks(decreaseListLevel,range)}else if(getNearest(splitNode,"BLOCKQUOTE")){return self.modifyBlocks(removeBlockQuote,range)}}nodeAfterSplit=splitBlock(this,splitNode,range.startContainer,range.startOffset);nodeAfterSplit.insertBefore(el,nodeAfterSplit.firstChild)}}else{var directChildOfBody=range.commonAncestorContainer;while(directChildOfBody.parentElement!==body){directChildOfBody=directChildOfBody.parentNode}body.insertBefore(el,directChildOfBody.nextSibling)}}range.selectNode(getLastTextNode(el)||el);range.collapse(false);this.focus();this.setSelection(range);this._updatePath(range);return this};proto.insertImage=function(src){var img=this.createElement("IMG",{src:src});this.insertElement(img);return img};proto.insertHTML=function(html){var range=this.getSelection(),frag=this._doc.createDocumentFragment(),div=this.createElement("DIV");div.innerHTML=html;frag.appendChild(empty(div));this._recordUndoState(range);this._getRangeAndRemoveBookmark(range);try{frag.normalize();addLinks(frag);cleanTree(frag,true);cleanupBRs(frag);removeEmptyInlines(frag);fixContainer(frag);var node=frag;while(node=getNextBlock(node)){fixCursor(node)}insertTreeFragmentIntoRange(range,frag);if(!canObserveMutations){this._docWasChanged()}range.collapse(false);this._ensureBottomLine();this.setSelection(range);this._updatePath(range,true)}catch(error){this.didError(error)}return this};var command=function(method,arg,arg2){return function(){this[method](arg,arg2);return this.focus()}};proto.addStyles=function(styles){if(styles){var head=this._doc.documentElement.firstChild,style=this.createElement("STYLE",{type:"text/css"});if(style.styleSheet){head.appendChild(style);style.styleSheet.cssText=styles}else{style.appendChild(this._doc.createTextNode(styles));head.appendChild(style)}}return this};proto.bold=command("changeFormat",{tag:"B"});proto.italic=command("changeFormat",{tag:"I"});proto.underline=command("changeFormat",{tag:"U"});proto.strikethrough=command("changeFormat",{tag:"S"});proto.subscript=command("changeFormat",{tag:"SUB"},{tag:"SUP"});proto.superscript=command("changeFormat",{tag:"SUP"},{tag:"SUB"});proto.removeBold=command("changeFormat",null,{tag:"B"});proto.removeItalic=command("changeFormat",null,{tag:"I"});proto.removeUnderline=command("changeFormat",null,{tag:"U"});proto.removeStrikethrough=command("changeFormat",null,{tag:"S"});proto.removeSubscript=command("changeFormat",null,{tag:"SUB"});proto.removeSuperscript=command("changeFormat",null,{tag:"SUP"});proto.makeLink=function(url,attributes){var range=this.getSelection();if(range.collapsed){var protocolEnd=url.indexOf(":")+1;if(protocolEnd){while(url[protocolEnd]==="/"){protocolEnd+=1}}insertNodeInRange(range,this._doc.createTextNode(url.slice(protocolEnd)))}if(!attributes){attributes={}}attributes.href=url;this.changeFormat({tag:"A",attributes:attributes},{tag:"A"},range);return this.focus()};proto.removeLink=function(){this.changeFormat(null,{tag:"A"},this.getSelection(),true);return this.focus()};proto.setFontFace=function(name){this.changeFormat({tag:"SPAN",attributes:{"class":"font",style:"font-family: "+name+", sans-serif;"}},{tag:"SPAN",attributes:{"class":"font"}});return this.focus()};proto.setFontSize=function(size){this.changeFormat({tag:"SPAN",attributes:{"class":"size",style:"font-size: "+(typeof size==="number"?size+"px":size)}},{tag:"SPAN",attributes:{"class":"size"}});return this.focus()};proto.setTextColour=function(colour){this.changeFormat({tag:"SPAN",attributes:{"class":"colour",style:"color: "+colour}},{tag:"SPAN",attributes:{"class":"colour"}});return this.focus()};proto.setHighlightColour=function(colour){this.changeFormat({tag:"SPAN",attributes:{"class":"highlight",style:"background-color: "+colour}},{tag:"SPAN",attributes:{"class":"highlight"}});return this.focus()};proto.setTextAlignment=function(alignment){this.forEachBlock(function(block){block.className=(block.className.split(/\s+/).filter(function(klass){return!/align/.test(klass)}).join(" ")+" align-"+alignment).trim();block.style.textAlign=alignment},true);return this.focus()};proto.setTextDirection=function(direction){this.forEachBlock(function(block){block.className=(block.className.split(/\s+/).filter(function(klass){return!/dir/.test(klass)}).join(" ")+" dir-"+direction).trim();block.dir=direction},true);return this.focus()};proto.increaseQuoteLevel=command("modifyBlocks",increaseBlockQuoteLevel);proto.decreaseQuoteLevel=command("modifyBlocks",decreaseBlockQuoteLevel);proto.makeUnorderedList=command("modifyBlocks",makeUnorderedList);proto.makeOrderedList=command("modifyBlocks",makeOrderedList);proto.removeList=command("modifyBlocks",removeList);proto.increaseListLevel=command("modifyBlocks",increaseListLevel);proto.decreaseListLevel=command("modifyBlocks",decreaseListLevel);if(top!==win){win.editor=new Squire(doc);if(win.onEditorLoad){win.onEditorLoad(win.editor);win.onEditorLoad=null}}else{win.Squire=Squire}})(document);